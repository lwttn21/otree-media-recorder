{{ block title }}Audio Recorder{{ endblock }}

{{ block content }}

<div style="text-align: center; padding: 20px;">
    <h2>Aufnahme lÃ¤uft</h2>
    <p id="status">ðŸ”´ Aufnahme wird vorbereitet...</p>
    <p id="timer" style="font-size: 24px; font-weight: bold;">10:00</p>
</div>

<script>
    const status = document.getElementById('status');
    const timerDisplay = document.getElementById('timer');
    let mediaRecorder = null;
    let chunks = [];
    let uploadTriggered = false;

    const TOTAL_SECONDS = 30;  // 10 Minuten
    const UPLOAD_BEFORE_END = 5;  // Upload 5 Sekunden vor Ende
    let remainingSeconds = TOTAL_SECONDS;

    // Timer-Anzeige aktualisieren
    function updateTimer() {
        const minutes = Math.floor(remainingSeconds / 60);
        const seconds = remainingSeconds % 60;
        timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

        // Upload 5 Sekunden vor Ende triggern
        if (remainingSeconds === UPLOAD_BEFORE_END && !uploadTriggered) {
            uploadTriggered = true;
            stopAndUpload();
        }

        if (remainingSeconds > 0) {
            remainingSeconds--;
            setTimeout(updateTimer, 1000);
        }
    }

    // Aufnahme und Upload
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then((stream) => {
                mediaRecorder = new MediaRecorder(stream);

                // Aufnahme starten
                mediaRecorder.start();
                status.textContent = 'ðŸ”´ Aufnahme lÃ¤uft...';
                console.log('Aufnahme gestartet');

                // Timer starten
                updateTimer();

                mediaRecorder.ondataavailable = (e) => {
                    chunks.push(e.data);
                };

                mediaRecorder.onstop = (e) => {
                    const blob = new Blob(chunks, { type: 'audio/webm' });
                    console.log('Blob erstellt, GrÃ¶ÃŸe:', blob.size, 'bytes');
                    status.textContent = 'â³ Speichere Aufnahme...';

                    // Upload durchfÃ¼hren
                    const reader = new FileReader();
                    reader.onloadend = function() {
                        liveSend({'audio': reader.result});
                    };
                    reader.readAsDataURL(blob);
                };
            })
            .catch((err) => {
                console.error(`getUserMedia error: ${err}`);
                status.textContent = 'Fehler: Mikrofon-Zugriff verweigert';
            });
    } else {
        status.textContent = 'Fehler: getUserMedia wird nicht unterstÃ¼tzt';
    }

    function stopAndUpload() {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            console.log('Stoppe Aufnahme fÃ¼r Upload...');
            mediaRecorder.stop();
        }
    }

    function liveRecv(data) {
        if (data.status === 'saved') {
            status.textContent = 'âœ… Aufnahme gespeichert!';
            console.log('Upload erfolgreich:', data.filename);
        }
    }
    window.liveRecv = liveRecv;
</script>

{{ endblock }}