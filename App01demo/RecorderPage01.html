{{ block title }}Aufnahme - Player 1{{ endblock }}

{{ block content }}

<div style="text-align: center; padding: 20px;">
    <h2>ðŸŽ¤ Player 1 - Aufnahme lÃ¤uft</h2>
    <p style="color: #666;">Dies ist die spezifische Seite fÃ¼r Player 1</p>
    <p id="status">ðŸ”´ Aufnahme wird vorbereitet...</p>
    <p id="timer" style="font-size: 24px; font-weight: bold;">0:30</p>
</div>

<script>
    const status = document.getElementById('status');
    const timerDisplay = document.getElementById('timer');
    let mediaRecorder = null;
    let chunks = [];
    let uploadTriggered = false;
    
    const TOTAL_SECONDS = 30;
    const UPLOAD_BEFORE_END = 5;
    let remainingSeconds = TOTAL_SECONDS;

    function updateTimer() {
        const minutes = Math.floor(remainingSeconds / 60);
        const seconds = remainingSeconds % 60;
        timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        if (remainingSeconds === UPLOAD_BEFORE_END && !uploadTriggered) {
            uploadTriggered = true;
            stopAndUpload();
        }
        
        if (remainingSeconds > 0) {
            remainingSeconds--;
            setTimeout(updateTimer, 1000);
        }
    }

    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then((stream) => {
                mediaRecorder = new MediaRecorder(stream);

                mediaRecorder.start();
                status.textContent = 'ðŸ”´ Aufnahme lÃ¤uft... (Player 1)';
                console.log('Player 1: Aufnahme gestartet');
                
                updateTimer();

                mediaRecorder.ondataavailable = (e) => {
                    chunks.push(e.data);
                };

                mediaRecorder.onstop = (e) => {
                    const blob = new Blob(chunks, { type: 'audio/webm' });
                    console.log('Player 1: Blob erstellt, GrÃ¶ÃŸe:', blob.size, 'bytes');
                    status.textContent = 'â³ Speichere Aufnahme...';
                    
                    const reader = new FileReader();
                    reader.onloadend = function() {
                        liveSend({'audio': reader.result});
                    };
                    reader.readAsDataURL(blob);
                };
            })
            .catch((err) => {
                console.error(`getUserMedia error: ${err}`);
                status.textContent = 'Fehler: Mikrofon-Zugriff verweigert';
            });
    } else {
        status.textContent = 'Fehler: getUserMedia wird nicht unterstÃ¼tzt';
    }

    function stopAndUpload() {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            console.log('Player 1: Stoppe Aufnahme fÃ¼r Upload...');
            mediaRecorder.stop();
        }
    }

    function liveRecv(data) {
        if (data.status === 'saved') {
            status.textContent = 'âœ… Aufnahme gespeichert! (Player 1)';
            console.log('Player 1: Upload erfolgreich:', data.filename);
        }
    }
    window.liveRecv = liveRecv;
</script>

{{ endblock }}
